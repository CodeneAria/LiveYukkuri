<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚Œã„ã‚€ - ç”»åƒãƒ¬ã‚¤ãƒ¤ãƒ¼é‡ã­åˆã‚ã›</title>
    <style>
        body {
            font-family: 'Segoe UI', Meiryo, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .image-container {
            position: relative;
            width: 500px;  /* ç”»åƒã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ */
            height: 500px;
            background-color: white;
            border: 2px solid #ccc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* é‡ãªã‚Šé †ã®æŒ‡å®šï¼ˆz-indexãŒå¤§ãã„ã»ã©ä¸Šï¼‰ */
        .layer-body {
            z-index: 1;
        }

        .layer-face {
            z-index: 2;
        }

        .layer-eyebrows {
            z-index: 3;
        }

        .layer-eyes {
            z-index: 4;
        }

        .layer-mouth {
            z-index: 5;
        }

        .info {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 500px;
        }

        .info h2 {
            margin-top: 0;
            color: #555;
            font-size: 18px;
        }

        .info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info li {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>ğŸ¨ ã‚Œã„ã‚€ - ãƒ¬ã‚¤ãƒ¤ãƒ¼é‡ã­åˆã‚ã›ãƒ‡ãƒ¢</h1>

    <div class="image-container">
        <img src="/images/ä½“/00.png" class="layer-body" alt="ä½“">
        <img src="/images/é¡”/00a.png" class="layer-face" alt="é¡”">
        <img src="/images/çœ‰/07.png" class="layer-eyebrows" alt="çœ‰">
        <img src="/images/ç›®/00.png" class="layer-eyes" alt="ç›®">
        <img src="/images/å£/00.png" class="layer-mouth" alt="å£">
    </div>

    <div class="info">
        <h2>ğŸ“‹ è¡¨ç¤ºä¸­ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>
        <ul>
            <li><strong>ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆæœ€ä¸‹å±¤ï¼‰ï¼š</strong>ã‚Œã„ã‚€/ä½“/00.png</li>
            <li><strong>ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼š</strong>ã‚Œã„ã‚€/é¡”/00a.png</li>
            <li><strong>ãƒ¬ã‚¤ãƒ¤ãƒ¼3ï¼š</strong>ã‚Œã„ã‚€/çœ‰/00.png</li>
            <li><strong>ãƒ¬ã‚¤ãƒ¤ãƒ¼4ï¼š</strong>ã‚Œã„ã‚€/ç›®/00.png</li>
            <li><strong>ãƒ¬ã‚¤ãƒ¤ãƒ¼5ï¼ˆæœ€ä¸Šå±¤ï¼‰ï¼š</strong>ã‚Œã„ã‚€/å£/00.png</li>
        </ul>
        <p style="color: #888; font-size: 14px; margin-top: 15px;">
            â€» é€éPNGç”»åƒãŒé‡ã­åˆã‚ã›è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™
        </p>
        <p style="color: #4a90e2; font-size: 14px; margin-top: 10px;">
            ğŸ¬ ç¬ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­ï¼ˆ2ç§’ã”ã¨ã«ç¬ãï¼‰
        </p>
    </div>

    <script>
        // ===== ç¬ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ =====
        const eyesLayer = document.querySelector('.layer-eyes');
        let isBlinking = false;

        const blinkSequence = [
            '00.png',
            '00a.png',
            '00b.png',
            '00c.png',
            '00d.png',
            '00e.png',
            '00d.png',
            '00c.png',
            '00b.png',
            '00a.png',
            '00.png'
        ];

        function executeBlink() {
            if (isBlinking) return;
            isBlinking = true;
            let frameIndex = 0;
            const blinkInterval = setInterval(() => {
                if (frameIndex < blinkSequence.length) {
                    eyesLayer.src = `/images/ç›®/${blinkSequence[frameIndex]}`;
                    frameIndex++;
                } else {
                    clearInterval(blinkInterval);
                    isBlinking = false;
                }
            }, 20);
        }

        setInterval(() => {
            if (Math.random() >= 0.9) executeBlink();
        }, 200);

        // ===== å£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ =====
        const mouthLayer = document.querySelector('.layer-mouth');

        // æ­£è¦åŒ–å€¤ï¼ˆ0ã€œ1ï¼‰ã‚’å£ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã«å¤‰æ›ã™ã‚‹
        // 0.0 â†’ 00.png, 1.0 â†’ 00e.png ã®6æ®µéš
        const mouthImages = ['00.png', '00a.png', '00b.png', '00c.png', '00d.png', '00e.png'];
        function soundValueToMouthImage(value) {
            const index = Math.min(Math.floor(value * mouthImages.length), mouthImages.length - 1);
            return mouthImages[index];
        }

        let isMouthPlaying = false;

        // sound_values ã‚’é †ç•ªã«å†ç”Ÿã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹
        function playMouthAnimation(soundValues, sampleTimeMs) {
            if (isMouthPlaying) return;
            isMouthPlaying = true;

            let i = 0;
            function step() {
                if (i < soundValues.length) {
                    mouthLayer.src = `/images/å£/${soundValueToMouthImage(soundValues[i])}`;
                    i++;
                    setTimeout(step, sampleTimeMs);
                } else {
                    // å†ç”Ÿçµ‚äº† â†’ å£ã‚’é–‰ã˜ãŸçŠ¶æ…‹ã«æˆ»ã™
                    mouthLayer.src = '/images/å£/00.png';
                    isMouthPlaying = false;
                }
            }
            step();
        }

        // ã‚µãƒ¼ãƒãƒ¼ã®ã‚­ãƒ¥ãƒ¼ã‚’å®šæœŸçš„ã«ç¢ºèªã™ã‚‹ï¼ˆ100msã”ã¨ï¼‰
        setInterval(async () => {
            if (isMouthPlaying) return; // å†ç”Ÿä¸­ã¯ãƒãƒ¼ãƒªãƒ³ã‚°ã—ãªã„
            try {
                const res = await fetch('/sound_queue');
                const json = await res.json();
                if (json.status === 'ok' && json.data) {
                    const { sound_values, sample_time } = json.data;
                    playMouthAnimation(sound_values, sample_time * 1000);
                }
            } catch (e) {
                // ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„å ´åˆã¯ç„¡è¦–
            }
        }, 100);
    </script>
</body>
</html>
